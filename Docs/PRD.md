# Ceramics Studio Check-In App — Product Requirements Document (v0.3)

> **Scope trimmed to MVP** — simple member check‑in / check‑out only, per stakeholder revision on 2025‑05‑18.

---

## 1 · Purpose
Enable a 24 × 7 ceramics studio to see **who is inside right now** and maintain an audit trail of historical visits.  
_No payments, plan types, kiosk, or advanced accessibility features._

### Success criteria
| Metric | Target |
|---|---|
| Successful check‑in events | ≥ 98 % |
| Auto check‑out accuracy | ≥ 95 % |
| Admin report generation | < 5 s |
| Production uptime | ≥ 99 % |
| Elder-user usability test | 1 pilot member (age 65+) completes check-in/out unassisted |

---

## 2 · Users
* **Member** — any age, logs in once, swipes to check in/out.  
* **Admin / Super‑Admin** — views logs, manages accounts.

---

## 3 · Core Workflows

0. **Invite**  
   – Admin creates a member record (name, email, profile photo) in the dashboard and sends the app-download + one-time-login link generated by Supabase.

1. **Check‑in**  
   A. Member opens app (already authenticated).  
   B. Swipes large “Slide to Check In” control.  
   C. Server records `check_in` timestamp + device coarse location (GPS ± 50 m).  

2. **Auto Check‑out**  
   – Background task polls GPS every 10 min; if distance > 150 m from studio **or** device offline > 12 h, server sets `check_out` timestamp.  

3. **Manual Check‑out** (optional)  
   – Member swipes “Slide to Check Out”.

4. **Admin Review**  
   – Web dashboard table: filter by date, export CSV.

---

## 4 · Functional Requirements

### 4.1 Mobile App (React Native — iOS & Android)

| ID | Requirement |
|---|---|
| F‑1 | Email + password login (retain session via secure token). |
| F‑2 | Single screen with swipe control; displays current status & session timer. |
| F‑3 | Auto check‑out via geofence (150 m radius) or 12 h max; requires `ACCESS_FINE_LOCATION` **and** `ACCESS_BACKGROUND_LOCATION` on Android 14+. |
| F‑4 | Offline queue (LocalStorage) and sync when online. |
| F‑5 | Localisation: English & Swedish copy only. |

### 4.2 Admin Web Dashboard (Next.js)

| ID | Requirement |
|---|---|
| A‑1 | Members CRUD (name, email, status, profile photo). |
| A‑2 | Table of sessions with filters + CSV export. |
| A‑3 | Current occupancy count. |

### 4.3 Backend (Supabase Postgres)

| ID | Requirement |
|---|---|
| B‑1 | Edge RPC for `check_in` / `check_out`. |
| B‑2 | Webhook/cron to close stale sessions. |
| B‑3 | Row‑level security so members can only read their own sessions. |

* **Overlap rule** – If a `sessions` row exists for the same `member_id` with `check_out IS NULL`, the `check_in` function **updates** that row instead of inserting a new one.

#### Authentication & Security

| ID | Requirement |
|----|-------------|
| S-1 | **Password strength**: ≥ 12 chars, at least 1 digit & 1 symbol; reject passwords on Have-I-Been-Pwned list. |
| S-2 | **Password reset**: email magic-link valid 15 min; token single-use. |
| S-3 | **Rate-limit** login: max 5 attempts / IP / min; exponential back-off. |
| S-4 | **Session expiry**: refresh JWT every 7 days, force sign-in after 30 days idle. |
| S-5 | **Location permission**: request *Always* on iOS **and** Android 14+. If user chooses *While-Using*, show a friendly second-chance dialog explaining auto check-out limitations; fall back to “significant-change” updates when permanent permission is not granted. |
| S-6 | **Transport security**: TLS 1.3 for all requests; HSTS header on dashboard. |
| S-7 | **PII masking in logs**: store member ID only; no raw email or GPS lat/long. |

---

## 5 · Non-Functional

| Category | Requirement |
|----------|-------------|
| **Performance** | API p95 latency ≤ 300 ms; mobile bundle ≤ 3 MB. |
| **Crash‑free sessions** | ≥ 99 % (Sentry rolling 7‑day metric). |
| **Availability** | ≥ 99 % monthly (Edge Free), target 99.5 % once on Pro. |
| **Security** | TLS 1.3, OWASP Top-10 scan quarterly, Sentry error capture. |
| **Privacy** | GDPR compliant; lawful basis “legitimate interest” for access control. |
| **Audit & Back-ups** | WAL & daily snapshot (retain 7 days on Free, 30 days on Pro). |
| **Data residency** | EU-West (Frankfurt). |
| **Accessibility** | System font ≥ 18 pt, WCAG 2.1 AA contrast. |
| **Disaster recovery** | Quarterly restore drill to staging; verify sessions row-count matches production snapshot. |

---

## 6 · Architecture

```
Member App ──▶ Supabase Edge ──▶ Postgres
               ▲
Admin Dashboard ┘
```

*Dashed link indicates the scheduled `autoCheckout` Edge Function (runs every 15 min on Free tier).*

**Backend**
Supabase Edge Functions (TypeScript)

**Mobile**
React Native (Expo) + TypeScript

**Admin Web**
Next.js 15 (app‑router) + TypeScript

**Supabase**
Postgres + Supabase Edge

**CI/CD**
ESLint/Prettier, Jest, and Commitlint.
   * *Dependency hygiene* – `pnpm audit` (JS) and `pip-audit` (Edge Function helper scripts) **must** pass with zero critical vulnerabilities.

**File Naming Conventions**
1. ***Edge Functions (TypeScript)***
   *Directory:* supabase/functions/
   *Pattern:* camelCase.ts
   *Example:* autoCheckout.ts

2. ***TypeScript Components***
   *Directory:* mobile/src/screens
   *Pattern:* PascalCase.tsx
   *Example:* SessionScreen.tsx

3. ***TypeScript Hooks & Utils***
   *Directory:* mobile/src/hooks
   *Pattern:* useCamelCase.ts
   *Example:* useBackgroundLocation.ts

4. ***Tests (all)***
   *Directory:* alongside source
   *Pattern:* <name>.test.ts
   *Example:* sessionService.test.ts, SessionScreen.test.tsx

---

## 7 · Data Model (simplified)

```sql
-- members
id UUID PRIMARY KEY,
full_name TEXT,
email TEXT UNIQUE,
photo_url TEXT,
status TEXT DEFAULT 'active';

-- sessions
id UUID PRIMARY KEY,
member_id UUID REFERENCES members,
check_in TIMESTAMP NOT NULL,
check_out TIMESTAMP,
auto_closed BOOLEAN DEFAULT false;
```

---

## 8 · Cost Estimate (Year 1 — Supabase Free)

| Item | Monthly | Annual |
|---|---|---|
| Supabase **Free** Tier | €0 | €0 |
| Vercel Hobby | €0 | €0 |
| Apple developer account | — | €99 |
| Google Play listing | — | €25 |
| Sentry Free (5 k events) | €0 | €0 |
| UptimeRobot Free | €0 | €0 |
| **Total** | **≈ €124** |

> **Upgrade trigger:** move to Supabase **Pro (€25 / mo)** when any apply:  
> • Need cron < 15 min (Free tier minimum) or 30-day backups • DB > 300 MB • Realtime connections > 200.

---

## 9 · Timeline

| Phase | Weeks |
|---|---|
| Setup & auth | 1 |
| Core swipe flow | 2 |
| Auto check‑out logic | 1 |
| Admin dashboard | 1 |
| QA & launch | 1 |
| **Total** | **6 weeks** |

> **Code‑freeze:** end of Week 5 so QA has one full week on a release candidate.

---

## 10 · Open Items

1. **Geofence constants**  
   * Radius = 150 m; check every 15 min.  
   * Auto check-out triggers after **two consecutive misses** (≥ 20 min outside).  
2. **Offline queue caps**  
   * Mobile stores max **25 unsynced events**; oldest discarded after that.  
   * On sync, server **upserts** if an overlapping session already exists.  
3. **iOS background permission messaging**  
   * Draft copy for second-chance prompt if user selects *While-Using*.  
4. **Supabase Pro upgrade trigger**  
   * Decide if upgrade occurs on **> 15 min cron requirement** or storage overage (see Cost table).

## Appendix A · Glossary

| Term | Definition |
|------|------------|
| **Session** | The time span between a `check_in` timestamp and its corresponding `check_out`. |
| **Auto check-out** | Server-side action that closes a session when the device leaves the 150 m geofence or after 12 h of inactivity. |
| **Overlap rule** | Logic that converts a second check-in to an update if a session is already open. |
| **Edge Function** | A TypeScript function that runs in Supabase’s Deno edge runtime. |
| **Invite link** | One-time magic link emailed to a new member to set an initial password and log in. |


